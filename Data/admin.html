<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f4f4f4;
        }

        button {
            padding: 4px 8px;
        }

        label, select, input {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <h1>Tool Admin Panel</h1>

    <label>Admin Token: </label>
    <input type="text" id="adminToken" style="width: 300px;">
    <button onclick="loadUsers()">Load Users</button>

    <label>Filter by role: </label>
    <select id="roleFilter" onchange="loadUsers()">
        <option value="">All</option>
        <option value="user">User</option>
        <option value="admin">Admin</option>
    </select>

    <table id="usersTable">
        <thead>
            <tr>
                <th>Username</th>
                <th>Token</th>
                <th>Role</th>
                <th>Last Login</th>
                <th>Login Count</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const API_BASE = "https://localhost:7119";

        async function loadUsers() {
            const token = document.getElementById('adminToken').value.trim();
            const roleFilter = document.getElementById('roleFilter').value;

            if (!token) {
                alert('Please enter your admin token.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/admin/users?token=${encodeURIComponent(token)}`);
                if (!response.ok) {
                    alert('Unauthorized or invalid token.');
                    return;
                }

                let users = await response.json();

                if (roleFilter) {
                    users = users.filter(u => u.role === roleFilter);
                }

                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = '';

                users.forEach(u => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                            <td>${u.username}</td>
                            <td>${u.token || ''}</td>
                            <td>${u.role}</td>
                            <td>${u.lastLogin || ''}</td>
                            <td>${u.loginCount || 0}</td>
                            <td>
                                <button onclick="revokeToken('${u.username}')">Revoke Token</button>
                            </td>
                        `;
                    tbody.appendChild(row);
                });
            } catch (err) {
                console.error(err);
                alert('Failed to load users.');
            }
        }

        async function revokeToken(username) {
            const adminToken = document.getElementById('adminToken').value.trim();
            if (!confirm(`Revoke token for ${username}?`)) return;

            try {
                const response = await fetch(
                    `${API_BASE}/auth/admin/revoke?username=${encodeURIComponent(username)}&token=${encodeURIComponent(adminToken)}`,
                    { method: 'POST' }
                );
                if (!response.ok) {
                    alert('Failed to revoke token.');
                    return;
                }

                alert('Token revoked successfully!');
                loadUsers();
            } catch (err) {
                console.error(err);
                alert('Error revoking token.');
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@7.0.5/dist/browser/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()

            .withUrl("https://localhost:7119/userHub")
            .build();

        connection.on("UserListUpdated", () => {
            console.log("🔄 User list changed — refreshing...");
            loadUsers();
        });

        connection.start()
            .then(() => console.log("✅ SignalR connected to userHub"))
            .catch(err => console.error("❌ SignalR error:", err));
    </script>
</body>
</html>
